<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecuriSite-IA - Tableau de Bord</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/securisite.css') }}">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <h1 class="logo">SecuriSite-IA</h1>
        </div>
        <div class="header-right">
            <span class="user-greeting">Bonjour Badr Eddine</span>
            <div class="user-avatar">
                <span class="material-icons">account_circle</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Navigation Date -->
        <div class="date-navigation">
            <button class="date-nav-btn" onclick="navigateDate(-1)" title="Jour précédent">
                <span class="material-icons">chevron_left</span>
            </button>
            <div class="date-selector">
                <input type="date" id="datePicker" value="{{ selected_date }}" onchange="loadByDate()">
                <span id="currentDateDisplay">{{ current_date_display }}</span>
            </div>
            <button class="date-nav-btn" onclick="navigateDate(1)" title="Jour suivant">
                <span class="material-icons">chevron_right</span>
            </button>
        </div>

        <!-- Titre Principal -->
        <h1 class="page-title">Rapport de Sécurité - {{ current_date_display }}</h1>

        <!-- Widget Score Global -->
        <div class="risk-score-widget" style="background-color: {{ risk_color }}20; border-left: 6px solid {{ risk_color }};">
            <div class="score-display">
                <div class="score-number">{{ "%.1f"|format(risk_score) }}</div>
                <div class="score-max">/10</div>
            </div>
            <div class="score-label">{{ risk_level }}</div>
            <div class="score-summary">
                {{ risks|length }} risque{{ 's' if risks|length > 1 else '' }} identifié{{ 's' if risks|length > 1 else '' }}
                {% if risks|selectattr('severity', 'ge', 8)|list|length > 0 %}
                nécessitant une action immédiate
                {% endif %}
            </div>
        </div>

        <!-- Liste des Risques -->
        <section class="risks-section">
            <h2 class="section-title">Détail des Risques Majeurs</h2>
            
            {% if risks %}
                <div class="risks-list">
                    {% for risk in risks %}
                    <div class="risk-card" onclick="navigateToRisk('{{ risk.id }}')" 
                         style="border-left: 4px solid {% if risk.severity >= 8 %}#D32F2F{% elif risk.severity >= 6 %}#F57C00{% else %}#388E3C{% endif %};">
                        <div class="risk-content">
                            <div class="risk-header">
                                <span class="material-icons risk-icon">warning</span>
                                <h3 class="risk-title">{{ risk.title }}</h3>
                                <div class="severity-badge" 
                                     style="background-color: {% if risk.severity >= 8 %}#D32F2F{% elif risk.severity >= 6 %}#F57C00{% else %}#388E3C{% endif %};">
                                    {{ risk.severity }}/10
                                </div>
                            </div>
                            <div class="risk-location">
                                <span class="material-icons">location_on</span>
                                <span>{{ risk.location }}</span>
                            </div>
                            <div class="risk-time">
                                <span class="material-icons">schedule</span>
                                <span>{{ risk.timestamp.split(' ')[0] }}, {{ risk.timestamp.split(' ')[1][:5] }}</span>
                            </div>
                        </div>
                        <div class="risk-arrow">
                            <span class="material-icons">arrow_forward</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-risks">
                    <span class="material-icons success-icon">check_circle</span>
                    <h3>Aucun risque majeur détecté</h3>
                    <p>Toutes les zones surveillées respectent les consignes de sécurité.</p>
                </div>
            {% endif %}
        </section>

        <!-- Refresh Button -->
        <div class="refresh-section">
            <button class="refresh-btn" onclick="refreshAnalysis()">
                <span class="material-icons">refresh</span>
                Actualiser l'analyse
            </button>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Analyse en cours...</p>
        </div>
    </div>

    <script>
        function navigateToRisk(riskId) {
            // Ajouter un feedback visuel
            event.currentTarget.style.transform = 'scale(0.98)';
            setTimeout(() => {
                window.location.href = `/risk/${riskId}`;
            }, 150);
        }

        function refreshAnalysis() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'flex';
            
            // Simuler le temps d'analyse
            setTimeout(() => {
                location.reload();
            }, 2000);
        }

        function navigateDate(days) {
            const currentDate = new Date(document.getElementById('datePicker').value);
            const newDate = new Date(currentDate);
            newDate.setDate(currentDate.getDate() + days);
            
            const newDateStr = newDate.toISOString().split('T')[0];
            window.location.href = `/?date=${newDateStr}`;
        }

        function loadByDate() {
            const selectedDate = document.getElementById('datePicker').value;
            window.location.href = `/?date=${selectedDate}`;
        }

        // Set min/max date boundaries
        const initDatePicker = () => {
            const datePicker = document.getElementById('datePicker');
            const today = new Date();
            const oneWeekAgo = new Date(today);
            oneWeekAgo.setDate(today.getDate() - 7);
            
            datePicker.min = oneWeekAgo.toISOString().split('T')[0];
            datePicker.max = today.toISOString().split('T')[0];
        };

        // Auto-refresh every 5 minutes
        setInterval(() => {
            console.log('Auto-refresh triggered');
            // Dans une vraie implémentation, faire un appel API pour vérifier les nouveaux risques
        }, 5 * 60 * 1000);

        // Touch feedback for tablets
        document.querySelectorAll('.risk-card').forEach(card => {
            card.addEventListener('touchstart', function() {
                this.style.transform = 'scale(0.98)';
                this.style.transition = 'transform 0.1s ease';
            });
            
            card.addEventListener('touchend', function() {
                this.style.transform = 'scale(1)';
            });
        });

        // Initialize date picker on load
        document.addEventListener('DOMContentLoaded', initDatePicker);
    </script>
</body>
</html>